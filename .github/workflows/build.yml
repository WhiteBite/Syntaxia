name: Cross-platform Build + Release - Syntaxia

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Run Frontend Tests
        run: npm run test:run -- --coverage
        working-directory: frontend

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: backend/go.sum

      - name: Run Backend Tests
        run: go test ./application/... ./domain/... ./handlers/... ./infrastructure/... ./internal/... ./tests/... -short -count=1
        working-directory: backend

      - name: Create frontend dist placeholder
        run: mkdir -p backend/frontend/dist && touch backend/frontend/dist/.gitkeep

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: backend
          args: --config .golangci.yml --timeout 5m

  build:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
            build_name: SyntaxiaWB
            artifact_name: syntaxia-linux-amd64
            artifact_path: backend/build/bin/SyntaxiaWB

          - os: windows-latest
            platform: windows/amd64
            build_name: SyntaxiaWB.exe
            artifact_name: syntaxia-windows-amd64
            artifact_path: backend/build/bin/SyntaxiaWB.exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build Wails app
        uses: dAppServer/wails-build-action@main
        with:
          build-name: ${{ matrix.build_name }}
          build-platform: ${{ matrix.platform }}
          go-version: "1.24"
          package: false
          app-working-directory: backend

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

  build-macos:
    needs: test
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build macOS app
        run: wails build -platform darwin/arm64
        working-directory: backend

      - name: Package macOS app
        run: |
          cd backend/build/bin
          zip -r SyntaxiaWB.app.zip SyntaxiaWB.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: syntaxia-darwin-arm64
          path: backend/build/bin/SyntaxiaWB.app.zip
          if-no-files-found: error

  release:
    needs: [build, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: syntaxia-*
          path: release-assets

      - name: Prepare release metadata
        id: prep
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            IS_TAG="true"
          else
            TAG="v$(date -u '+%Y.%m.%d')-${GITHUB_SHA::7}"
            IS_TAG="false"
          fi
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Syntaxia $TAG" >> $GITHUB_OUTPUT
          echo "is_tag=$IS_TAG" >> $GITHUB_OUTPUT

      - name: Delete existing release (for auto-releases)
        if: steps.prep.outputs.is_tag == 'false'
        run: |
          gh release delete "${{ steps.prep.outputs.tag_name }}" --yes || true
          git push origin --delete "${{ steps.prep.outputs.tag_name }}" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD --no-merges | head -15)
          else
            COMMITS=$(git log --pretty=format:"- %s" -15 --no-merges)
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prep.outputs.tag_name }}
          name: ${{ steps.prep.outputs.release_name }}
          body: |
            <p align="center">
              <img src="https://raw.githubusercontent.com/WhiteBite/Syntaxia/main/syntaxia-icon.png" width="80">
            </p>
            
            <h2 align="center">ğŸš€ Syntaxia ${{ steps.prep.outputs.tag_name }}</h2>
            <p align="center"><i>AI-Powered Code Context Builder</i></p>
            
            ---
            
            ## ğŸ“¦ Downloads
            
            | Platform | File | Architecture |
            |----------|------|--------------|
            | ğŸªŸ Windows | `SyntaxiaWB.exe` | x64 |
            | ğŸ§ Linux | `SyntaxiaWB` | x64 |
            | ğŸ macOS | `SyntaxiaWB.app.zip` | Apple Silicon |
            
            ---
            
            ## ğŸ“ What's Changed
            
            ${{ steps.changelog.outputs.commits }}
            
            ---
            
            ## ğŸ”— Links
            
            [ğŸ“– Documentation](https://github.com/WhiteBite/Syntaxia#readme) â€¢ [ğŸ’¬ Telegram](https://t.me/whitebite_devsoft) â€¢ [ğŸ› Report Issue](https://github.com/WhiteBite/Syntaxia/issues)
          draft: false
          prerelease: ${{ steps.prep.outputs.is_tag == 'false' }}
          files: release-assets/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Telegram notification
        if: steps.prep.outputs.is_tag == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="96" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>Syntaxia ${{ steps.prep.outputs.tag_name }}</b>%0A%0A<i>AI-Powered Code Context Builder</i>%0A%0AğŸ“¦ <b>Downloads:</b>%0Aâ€¢ Windows (x64)%0Aâ€¢ Linux (x64)%0Aâ€¢ macOS (Apple Silicon)%0A%0AğŸ”— <a href=\"https://github.com/WhiteBite/Syntaxia/releases/tag/${{ steps.prep.outputs.tag_name }}\">GitHub Release</a>%0A%0A#syntaxia #release"
